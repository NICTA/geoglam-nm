#cloud-config

# Capture all cloud-config output into a more readable logfile
output: {all: '| tee -a /var/log/cloud-init-output.log'}

# update and install packages, reboot if necessary
package_upgrade: true
package_reboot_if_required: true
packages:
 - ntp
 - python-pip
 - nodejs-legacy
 - npm
 - varnish
 - gdal-bin
 - unzip
 - libwww-perl
 - libdatetime-perl
 - nginx

# any files to create
write_files:

 - path: /etc/varnish/default.vcl
   content: |
    backend default {
        .host = "127.0.0.1";
        .port = "81";
    }
    sub vcl_recv {
      if (req.url ~ "^/proxy"){
        return (lookup);
      }
    }
    sub vcl_fetch
    {
      remove beresp.http.Expires;
      if ( beresp.status != 200 ) {
        set beresp.http.Cache-Control = "no-cache";
        set beresp.ttl = 0s;
      }
    }

 - path: /etc/default/varnish
   content: |
    START=yes
    NFILES=131072
    MEMLOCK=82000
    DAEMON_OPTS="-a :80 -T localhost:6082 -f /etc/varnish/default.vcl -S /etc/varnish/secret -s memcache=malloc,1G -s filecache=file,/mnt/varnish_storage.bin,3G"

 - path: /etc/nginx/sites-enabled/default
   content: |
    server {
      listen 81;
      real_ip_header X-Forwarded-For;
      root /opt/nginx;
      index r.html;
      error_page 404 /r.html;
      location / { proxy_pass http://localhost:3001/; proxy_set_header Host $http_host; }
    }

 - path: /etc/rsyslog.d/30-geoglam-nm.conf
   content: |
    :syslogtag, isequal, "geoglam-nm:" /var/log/geoglam-nm.log
    & ~

 - path: /etc/init/geoglam-nm.conf
   content: |
    start on (net-device-up and local-filesystems and runlevel [2345])
    stop on runlevel [016]
    console log
    chdir /opt/geoglam-nm
    setuid nobody
    setgid nogroup
    exec bash -c "npm start 2>&1 | logger -t geoglam-nm"

# run all the commands to set this instance up
runcmd:
 - echo 'APT::Periodic::Unattended-Upgrade "1";' >> /etc/apt/apt.conf.d/10periodic
 - pip install awscli
 - npm install -g forever

# cloudwatch monitoring scripts
 - curl -so /tmp/CloudWatchMonitoringScripts-1.2.1.zip http://aws-cloudwatch.s3.amazonaws.com/downloads/CloudWatchMonitoringScripts-1.2.1.zip
 - unzip -d /opt /tmp/CloudWatchMonitoringScripts-1.2.1.zip
 - echo '*/5 * * * * ubuntu /opt/aws-scripts-mon/mon-put-instance-data.pl --mem-util --mem-used --mem-avail --disk-space-util --disk-path=/ --from-cron' > /etc/cron.d/cloudwatch

# geoglam-nm
 - aws s3 cp --region ap-southeast-2 s3://geoglam-apps/geoglam-nm-master-2016-04-15-54-g19cbebb.tar.gz /opt/geoglam-nm.tar.gz
 - mkdir /opt/geoglam-nm
 - tar xzf /opt/geoglam-nm.tar.gz -C /opt/geoglam-nm
 - touch /opt/geoglam-nm/terriajs.pid /opt/geoglam-nm/terriajs-server.log
 - chown nobody:nogroup /opt/geoglam-nm/terriajs.pid /opt/geoglam-nm/terriajs-server.log

# start/restart services
 - service rsyslog restart
 - service geoglam-nm start
 - service nginx restart
 - service varnish restart
